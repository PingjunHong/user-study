<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Study</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 40px auto; line-height: 1.5; }
        .card { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .question-block { margin-bottom: 20px; }
        .label { font-weight: bold; }
        .explanation { background: #f7f7f7; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
        .hidden { display: none; }
        .progress { margin-bottom: 10px; }
        .btn { padding: 8px 16px; border-radius: 4px; border: 1px solid #333; cursor: pointer; }

        /* Likert scale styling */
        .likert-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            gap: 10px;
        }
        .likert-item {
            text-align: center;
            flex: 1;
            font-size: 0.9em;
        }
        .likert-item input {
            display: block;
            margin: 0 auto 4px auto;
        }
    </style>
</head>
<body>

<h1>User Study</h1>
<div class="progress">
    <span id="progressText"></span>
    <span id="phaseText"></span>
</div>

<!-- Instruction card: content will be updated depending on phase -->
<div id="instructions" class="card"></div>

<div id="taskCard" class="card hidden">
    <div class="question-block">
        <div class="label">Original Question (Starter Question):</div>
        <div id="originalQuestion"></div>
    </div>

    <div class="question-block">
        <div class="label">Robot's Answer to the Starter Question:</div>
        <div id="modelAnswer"></div>
    </div>

    <div class="question-block">
        <div class="label">Follow-up Question:</div>
        <div id="followupQuestion"></div>
    </div>

    <div class="question-block hidden" id="explanationBlock">
        <div class="label">Explanation of the Robot's Reasoning:</div>
        <div id="explanationText" class="explanation"></div>
    </div>

    <form id="answerForm">
        <!-- Q1: Likert confidence -->
        <p><strong>1. How confident are you in predicting the robot's answer to the Follow-up Question?</strong></p>
        <p>
            Please rate your confidence on a 1–5 scale, where:<br>
            <strong>1</strong> = Not confident at all,&nbsp;
            <strong>5</strong> = Very confident,&nbsp;
            and values in between indicate intermediate confidence.
        </p>
        <div id="confidenceScale" class="likert-scale">
            <label class="likert-item">
                <input type="radio" name="confidence" value="1">
                1<br><span>Not confident at all</span>
            </label>
            <label class="likert-item">
                <input type="radio" name="confidence" value="2">
                2<br><span>Slightly confident</span>
            </label>
            <label class="likert-item">
                <input type="radio" name="confidence" value="3">
                3<br><span>Moderately confident</span>
            </label>
            <label class="likert-item">
                <input type="radio" name="confidence" value="4">
                4<br><span>Confident</span>
            </label>
            <label class="likert-item">
                <input type="radio" name="confidence" value="5">
                5<br><span>Very confident</span>
            </label>
        </div>

        <!-- Q2: Prediction Yes / No -->
        <div id="predictionBlock" style="margin-top: 20px;">
            <p><strong>2. What is your guess about the robot's answer to the Follow-up Question?</strong></p>
            <label>
                <input type="radio" name="prediction" value="yes"> The robot will answer: Yes
            </label><br>
            <label>
                <input type="radio" name="prediction" value="no"> The robot will answer: No
            </label>
        </div>

        <!-- Q3: free-text explanation -->
        <div style="margin-top: 20px;">
            <p><strong>3. Please briefly explain why you made this judgement.</strong></p>
            <p style="font-size: 0.9em; color: #555;">
                You can refer to the Starter Question, the Robot's Answer, the Follow-up Question,
                and (in Phase 2) the Explanation of the robot's reasoning.
            </p>
            <textarea id="annotatorExplanation" name="annotatorExplanation" rows="4" style="width: 100%;"
                      placeholder="Write a short explanation of why you chose this confidence level and prediction."></textarea>
        </div>

        <div style="margin-top: 20px;">
            <button type="submit" class="btn">Next</button>
        </div>
    </form>
</div>

<div id="doneMessage" class="hidden">
    <h2>Thank you!</h2>
    <p>You have completed all trials.</p>
</div>

<script>
    const TOTAL_TRIALS = {{ n_trials }};  // Number of trials passed from backend

    let currentIndex = 0;  // Current trial index
    let currentPhase = 1;  // 1 or 2
    let currentTrial = null;

    const taskCard = document.getElementById("taskCard");
    const doneMessage = document.getElementById("doneMessage");
    const progressText = document.getElementById("progressText");
    const phaseText = document.getElementById("phaseText");
    const instructionsDiv = document.getElementById("instructions");

    const originalQuestionDiv = document.getElementById("originalQuestion");
    const modelAnswerDiv = document.getElementById("modelAnswer");
    const followupQuestionDiv = document.getElementById("followupQuestion");
    const explanationBlock = document.getElementById("explanationBlock");
    const explanationTextDiv = document.getElementById("explanationText");

    const answerForm = document.getElementById("answerForm");
    const predictionBlock = document.getElementById("predictionBlock");
    const explanationInput = document.getElementById("annotatorExplanation");

    function updateProgress() {
        progressText.textContent = `Trial ${currentIndex + 1} of ${TOTAL_TRIALS}  `;
        phaseText.textContent = `(Phase ${currentPhase})`;
    }

    function updateInstructions() {
        if (!instructionsDiv) return;

        if (currentPhase === 1) {
            // Phase 1 instructions
            instructionsDiv.innerHTML = `
                <p><strong>Phase 1 Instructions</strong></p>
                <p>Thank you for participating in this task!</p>
                <p>For each HIT, you will see:</p>
                <ul>
                    <li>one yes/no <strong>Starter Question</strong>,</li>
                    <li>a <strong>Robot's Answer</strong> to the Starter Question, and</li>
                    <li>a <strong>Follow-up Question</strong>.</li>
                </ul>
                <p>Your tasks are:</p>
                <ol>
                    <li>Rate how confident you are in predicting the robot’s answer to the Follow-up Question on a 1–5 scale (1 = not confident at all, 5 = very confident).</li>
                    <li>Indicate what you think the robot's answer to the Follow-up Question will be (Yes or No).</li>
                    <li>Briefly explain why you made this judgement.</li>
                </ol>
                <p><strong>Important:</strong> Your task is <u>not</u> to annotate the correct answers to the Follow-up Questions, but rather to <strong>guess the robot’s answers</strong> and report your confidence in these guesses.</p>
            `;
        } else {
            // Phase 2 instructions
            instructionsDiv.innerHTML = `
                <p><strong>Phase 2 Instructions</strong></p>
                <p>Thank you for continuing with this task!</p>
                <p>For each HIT, you will now see:</p>
                <ul>
                    <li>the same yes/no <strong>Starter Question</strong>,</li>
                    <li>the <strong>Robot's Answer</strong> to the Starter Question,</li>
                    <li>the <strong>Follow-up Question</strong>, and</li>
                    <li>an <strong>Explanation</strong> of the robot's reasoning.</li>
                </ul>
                <p>Your tasks are:</p>
                <ol>
                    <li>Rate how confident you are in predicting the robot’s answer to the Follow-up Question, <strong>given the Explanation</strong>, on a 1–5 scale (1 = not confident at all, 5 = very confident).</li>
                    <li>Indicate what you think the robot's answer to the Follow-up Question will be (Yes or No).</li>
                    <li>Briefly explain why you made this judgement.</li>
                </ol>
                <p><strong>Important:</strong> As in Phase 1, your task is <u>not</u> to annotate the objectively correct answers to the Follow-up Questions, but to <strong>guess the robot’s answers</strong> and report your confidence.</p>
            `;
        }
    }

    function resetForm() {
        // Clear all selections / text
        const confidenceRadios = document.querySelectorAll("input[name='confidence']");
        const predictionRadios = document.querySelectorAll("input[name='prediction']");

        confidenceRadios.forEach(r => r.checked = false);
        predictionRadios.forEach(r => r.checked = false);
        explanationInput.value = "";

        // Prediction block is always visible in this design
        predictionBlock.classList.remove("hidden");
    }

    function loadTrial() {
        if (currentIndex >= TOTAL_TRIALS) {
            // All trials are completed
            taskCard.classList.add("hidden");
            doneMessage.classList.remove("hidden");
            return;
        }

        fetch(`/get_trial/${currentIndex}`)
            .then(resp => resp.json())
            .then(data => {
                if (data.done) {
                    taskCard.classList.add("hidden");
                    doneMessage.classList.remove("hidden");
                    return;
                }

                currentTrial = data;
                taskCard.classList.remove("hidden");
                doneMessage.classList.add("hidden");

                originalQuestionDiv.textContent = data.original_question || "";
                modelAnswerDiv.textContent = data.model_answer || "";
                followupQuestionDiv.textContent = data.followup_question || "";

                if (currentPhase === 2 && data.explanation) {
                    explanationTextDiv.textContent = data.explanation;
                    explanationBlock.classList.remove("hidden");
                } else {
                    explanationTextDiv.textContent = "";
                    explanationBlock.classList.add("hidden");
                }

                updateProgress();
                updateInstructions();
                resetForm();
            })
            .catch(err => {
                console.error("Error loading trial:", err);
            });
    }

    answerForm.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!currentTrial) return;

        // Read confidence (1–5)
        const confidenceRadios = document.querySelectorAll("input[name='confidence']");
        let confidenceValue = null;
        confidenceRadios.forEach(r => {
            if (r.checked) confidenceValue = r.value;
        });

        if (!confidenceValue) {
            alert("Please rate your confidence (1–5).");
            return;
        }
        const confidenceInt = parseInt(confidenceValue, 10);

        // Read prediction (Yes / No)
        const predictionRadios = document.querySelectorAll("input[name='prediction']");
        let predictionValue = null;
        predictionRadios.forEach(r => {
            if (r.checked) predictionValue = r.value;
        });

        if (!predictionValue) {
            alert("Please choose your prediction (Yes / No).");
            return;
        }

        // Read free-text explanation
        const explanationText = (explanationInput.value || "").trim();
        if (!explanationText) {
            alert("Please provide a short explanation for your judgement.");
            return;
        }

        // Build payload to send to backend
        const payload = {
            qid: currentTrial.qid,
            phase: currentPhase,
            transform_type: currentTrial.transform_type,
            original_question: currentTrial.original_question,
            model_answer: currentTrial.model_answer,
            followup_question: currentTrial.followup_question,
            explanation: currentPhase === 1 ? null : (currentTrial.explanation || null),
            confidence: confidenceInt,                      // NEW: Likert confidence (1–5)
            prediction: predictionValue,                    // Yes / No
            explanation_free_text: explanationText          // NEW: annotator explanation
        };

        fetch("/submit", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        })
            .then(resp => resp.json())
            .then(data => {
                if (data.status !== "ok") {
                    console.error("Submit error:", data);
                    alert("Error when submitting. Check console.");
                    return;
                }

                // After a successful submission:
                // Phase 1 -> Phase 2; Phase 2 -> next trial
                if (currentPhase === 1) {
                    currentPhase = 2;
                } else {
                    currentPhase = 1;
                    currentIndex += 1;
                }

                loadTrial();
            })
            .catch(err => {
                console.error("Submit failed:", err);
                alert("Network error when submitting.");
            });
    });

    // Initialize on page load
    window.addEventListener("load", function () {
        updateInstructions();  // Show Phase 1 instructions initially
        loadTrial();
    });
</script>

</body>
</html>
